# OCI API ゲートウェイではじめるサーバーレス・アプリケーション

## このチュートリアルで作成するアプリケーションの構成

### コンパートメント

コンパートメントについて。

### 仮想クラウド・ネットワーク

仮想クラウド・ネットワークについて。ナカグロの有無は要確認。API ゲートウェイはリージョナル・サブネットに配置しなければならない。QuickStart を使うと簡単

### Oracle Functions アプリケーションとファンクション

『[Oracle Functions ことはじめ][paasdocs_oraclefunctions]』参照のこと

## IAM ポリシーの設定

OCI では、Identity and Access Management （IAM） と呼ばれる仕組みによって各種リソースへのアクセスを制御します。

トライアル環境の場合は、トライアルに申し込んだユーザーは自動的に `Administrators` グループに所属しており、テナント内のすべてのリソースにアクセスできるポリシーが定義済みです。

商用環境を利用している場合は、API ゲートウェイを使用するための **ポリシー** を設定が必要なことがあります。
API ゲートウェイのインスタンスを作成したり、管理するためには、API ゲートウェイの管理者グループを作成し、管理操作 (manage) を許可するポリシーを定義します。

```text
Allow group ${API ゲートウェイの管理者グループの名前} to manage api-gateway-family in compartment ${コンパートメントの名前}
```

例えば、API ゲートウェイの管理者グループ名が `apigw-managers`、API ゲートウェイのインスタンスを作成するコンパートメントの名前が `apigw-compartment` の場合、ポリシーのステートメントは次のとおりです。

```text
Allow group apigw-managers to manage api-gateway-family in compartment apigw-compartment
```

### API ゲートウェイ・インスタンスから Oracle Functions のリソースへのアクセス

```text
Allow any-user to use functions-family in compartment ${Functions compartment name}
where
all {
  request.principal.type= 'ApiGateway',
  request.resource.compartment.id = ${API gateway's compartment id}
}
```

> ***注意:***
> 上のサンプルは、ポリシーの定義内容を理解しやすくするためにステートメントに改行を追加していますが、 OCI コンソールでポリシーを定義する際にはステートメントに改行を含めることはできません。
> ポリシーを定義する際には、適宜読み替えてください。

## ゲートウェイの作成

> ***注意:***
> テナント内に作成できるゲートウェイの数には上限が設定されており、初期状態では10に設定されています。
> 次のようなメッセージが表示された場合は、ゲートウェイの数がすでに上限に達していることを表しています。
>> ${上限に達しているよのメッセージ}
> ゲートウェイの数が上限に達している場合は、...

1.  OCI コンソールにログインします。
    OCI コンソールの画面の左上にあるハンバーガー・メニューをクリックし、 **「開発者メニュー」** → **「API ゲートウェイ」** を選択します。

1.  API ゲートウェイのページが表示されます。
    **「ゲートウェイの作成」** ボタンをクリックします。

1.  **「ゲートウェイの作成」** が表示されます。
    次の項目を指定します。

    + **「名前」** :
    + **「タイプ」** :
      作成するゲートウェイのタイプを選択します。
      このチュートリアルでは、**「パブリック」** を選択します。
    + **「コンパートメント」** :
      ゲートウェイを配置するコンパートメントを選択します。
    + **「仮想クラウド・ネットワーク」** :
    + **「サブネット」** :

    すべての項目を指定したら、 **「作成」** ボタンをクリックします。

1.  **「ゲートウェイの詳細」** ページが表示されます。

    ゲートウェイの作成が完了すると、ステータスがアクティブになります。

## デプロイメントの作成

1.  画面の左にある **「リソース」** メニューで **「デプロイメント」** を選択します。

    **「デプロイメントの作成」** ボタンをクリックします。

1.  **「基本情報」** を指定します。
    **「最初から」** が選択されていることを確認して、次の項目を入力します。

    + **「名前」** :
    + **「パス接頭辞」** :
    + **「コンパートメント」** :

    画面の左下にある **「次」** ボタンをクリックします。

1.  **「ルート」** の情報を入力します。

    + **「パス」** :
    + **「メソッド」** :
    + **「タイプ」** :
    + **「アプリケーション」** :
    + **「機能名」** :

    画面の下にある **「次」** ボタンをクリックします。

1.  **「確認」** 画面が表示され、ここまでに入力した内容が表示されます。
    **「保存」** ボタンをクリックします。

## アプリケーションのテスト

デプロイメントが作成されると、 **「デプロイメントの詳細」** ページに、デプロイメントのエンドポイントが表示されます。

<!-- Document Reference -->
[paasdocs_oraclefunctions]: https://oracle-japan.github.io/paasdocs/documents/faas/oraclefunctions/handson/getting-started/ "Oracle Functions ことはじめ"
