# OCI API ゲートウェイを使用したサーバーレス・アプリケーション

## このチュートリアルで作成するアプリケーション

![このチュートリアルで作成するアプリケーション][overview]

[overview]: images/overview.png "このチュートリアルで作成するアプリケーション"

### コンパートメント

コンパートメントについて。

### 仮想クラウド・ネットワーク (VCN)

仮想クラウド・ネットワークについて。API ゲートウェイはリージョナル・サブネットに配置しなければならない。QuickStart を使うと簡単

### Oracle Functions アプリケーションとファンクション

『[Oracle Functions ことはじめ][paasdocs]』参照のこと

[paasdocs]: https://oracle-japan.github.io/paasdocs/documents/faas/oraclefunctions/handson/getting-started/ "PaaS Docs - Oracle Functions ことはじめ"

## IAM ポリシーの設定

OCI では、Identity and Access Management （IAM） と呼ばれる仕組みによって各種リソースへのアクセスを制御します。

トライアル環境の場合は、トライアルに申し込んだユーザーは自動的に `Administrators` グループに所属しており、テナント内のすべてのリソースにアクセスできるポリシーが定義済みです。

商用環境を利用している場合は、API ゲートウェイを使用するための「ポリシー」を設定する必要があることがあります。
API ゲートウェイのインスタンスを作成したり、作成したインスタンスを管理したりするためには、API ゲートウェイの管理者グループを作成し、管理操作 (manage) を許可するポリシーを定義します。

```sh
Allow group ${API ゲートウェイの管理者グループの名前} to manage api-gateway-family in compartment ${コンパートメントの名前}
```

例えば API ゲートウェイの管理者グループ名が `apigw-managers`、API ゲートウェイのインスタンスを作成するコンパートメントの名前が `apigw-compartment` の場合、ポリシーのステートメントは次のとおりです。

```sh
Allow group apigw-managers to manage api-gateway-family in compartment apigw-compartment
```

ネットワークが使えるようにする必要がある

```sh
Allow group ${API ゲートウェイの管理者グループの名前} to use network-family in compartment ${コンパートメントの名前}
```

例えば、API ゲートウェイの管理者グループ名が `apigw-managers`、API ゲートウェイのリソースがアクセスする VNC が定義されているコンパートメントの名前が `apigw-compartment` の場合、ポリシーのステートメントは次のとおりです。

```sh
Allow group apigw-managers to manage api-gateway-family in compartment apigw-compartment
```

## API ゲートウェイ・インスタンスから Oracle Functions のリソースへのアクセス

```sh
Allow any-user to use functions-family in compartment ${Functions compartment name}
where
all {
  request.principal.type= 'ApiGateway',
  request.resource.compartment.id = ${API gateway compartment id}
}
```

> ***注意:***
> 上のサンプルは、ポリシーの定義内容を理解しやすくするためにステートメントに改行を追加していますが、 OCI コンソールでポリシーを定義する際にはステートメントに改行を含めることはできません。
> ポリシーを定義する際には、適宜読み替えてください。

## ゲートウェイの作成

1.  OCI コンソールにログインします。
    OCI コンソールの画面の左上にあるハンバーガー・アイコンをクリックし、 **「ソリューションおよびプラットフォーム」** にある **「開発者メニュー」** → **「API ゲートウェイ」** を選択します。

1.  API ゲートウェイのページが表示されます。
    画面左側の **「リスト範囲」** メニューの **「コンパートメント」** リストからゲートウェイを作成するコンパートメントを選択します。

    **「ゲートウェイの作成」** ボタンをクリックします。

1.  **「ゲートウェイの作成」** が表示されます。
    次の項目を指定します。

    + **「名前」** :
      ゲートウェイに付ける名前を入力します。
    + **「タイプ」** :
      作成するゲートウェイのタイプを選択します。
      このチュートリアルではインターネット経由でのリクエストを受け付けるために、 **「パブリック」** を選択します。
    + **「コンパートメント」** :
      ゲートウェイを配置するコンパートメントを選択します。
    + **「仮想クラウド・ネットワーク」** :
      ゲートウェイが使用する仮想クラウド・ネットワーク (VCN) を選択します。
      ゲートウェイを配置するコンパートメントと VCN が配置されているコンパートメントが異なる場合は、**「コンパートメントの変更」** をクリックして VCN が配置されているコンパートメントを選択する必要があります。
    + **「サブネット」** :
      このチュートリアルではゲートウェイが使用するパブリック・リージョナル・サブネットを選択します。

    すべての項目を指定したら、 **「作成」** ボタンをクリックします。

1.  **「ゲートウェイの詳細」** ページが表示されます。

    ゲートウェイの作成が完了すると、ステータスがアクティブになります。

> ***注意:***
> テナント内に作成できるゲートウェイの数には上限が設定されており、初期状態では10に設定されています。
> 次のようなメッセージが表示された場合は、ゲートウェイの数がすでに上限に達していることを表しています。
>
>> The following service limits were exceeded: gateway-count.
>> Request a service limit increase from the service limits page in the console.
>
> ゲートウェイの数が上限に達している場合は、上限の引き上げをリクエストできます。
> 詳細は、API ゲートウェイのドキュメントのサービス制限に関するページ（[英語版][servicelimits_en]/[日本語機械翻訳版][servicelimits_ja]）を参照してください。

[servicelimits_en]: https://docs.cloud.oracle.com/en-us/iaas/Content/General/Concepts/servicelimits.htm "API Gateway - Service Limit"
[servicelimits_ja]: https://docs.cloud.oracle.com/ja-jp/iaas/Content/General/Concepts/servicelimits.htm "API ゲートウェイ - サービス制限"

## API のデプロイ

1.  作成したゲートウェイの詳細ページにアクセスします。

1.  画面の左側にある **「リソース」** メニューから **「デプロイメント」** を選択します。

    **「デプロイメントの作成」** ボタンをクリックします。

1.  **「基本情報」** を指定します。
    **「最初から」** が選択されていることを確認して、次の項目を入力します。

    + **「名前」** :
      このデプロイメントに付ける名前を入力します。
    + **「パス接頭辞」** :
    + **「コンパートメント」** :
      デプロイする API が属するコンパートメントを選択します。
      子のチュートリアルでは、初期状態で選択されているゲートウェイが属しているコンパートメントを使用します。

    画面の左下にある **「次」** ボタンをクリックします。

1.  **「ルート」** の情報を入力します。

    + **「パス」** :
    + **「メソッド」** :
      対応する HTTP メソッドを選択します。
      このチュートリアルでは、**「GET」** と **「POST」** の２つを選択します。
    + **「タイプ」** :
      バックエンド・サービスの種類を選択します。
      このチュートリアルでは、 **「Oracle Functions」** を選択します。
    + **「アプリケーション」** :
    + **「機能名」** :

    画面の下にある **「次」** ボタンをクリックします。

1.  **「確認」** 画面が表示され、ここまでに入力した内容が表示されます。
    **「保存」** ボタンをクリックします。

## API のテスト

```sh
curl -i -k -X GET https://<ゲートウェイのホスト名>/<デプロイメントのパス接頭辞>/<ルートのパス>
```

```sh
curl -k -X POST https://<ゲートウェイのホスト名>/<デプロイメントのパス接頭辞>/<ルートのパス>
```

## ログの確認

デプロイメントの基本情報でロギングを有効した場合、ログは OCI オブジェクト・ストレージのストレージ・バケットに格納されます。

1.  OCI コンソールにログインしていない場合は、ログインします。
    画面左上のハンバーガー・アイコンをクリックし、 **「コア・インフラストラクチャ」** にある **「オブジェクト・ストレージ」** → **「オブジェクト・ストレージ」** を選択します。

    **「オブジェクト・ストレージ」** ページが表示されます。

1.  画面左側の **コンパートメント** で、API ゲートウェイを作成したコンパートメントを選択します。
